//users table
CREATE TABLE users (
  id BIGSERIAL PRIMARY KEY,
  tg_user_id BIGINT UNIQUE NOT NULL,
  first_name TEXT,
  user_name TEXT NOT NULL,
  currency_is VARCHAR(3) NOT NULL DEFAULT 'USD',
  balans NUMERIC(12,2) NOT NULL DEFAULT 0,
  language_is VARCHAR(2) NOT NULL DEFAULT 'en',
  created_date TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
  time_utc INTERVAL NOT NULL DEFAULT '0 hours',
  is_premium BOOLEAN NOT NULL DEFAULT TRUE,
  premium_date TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC')
);



//triggers for users 1
CREATE OR REPLACE FUNCTION set_premium_date()
RETURNS TRIGGER AS $$
BEGIN
    -- Only act if is_premium changes from false â†’ true
    IF (NOT OLD.is_premium AND NEW.is_premium) THEN
        NEW.premium_date := (CURRENT_TIMESTAMP AT TIME ZONE 'UTC') + INTERVAL '30 days';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_set_premium_date
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION set_premium_date();


//2
CREATE OR REPLACE FUNCTION set_initial_premium_date()
RETURNS TRIGGER AS $$
BEGIN
    -- If premium_date is not set, give 3-day trial (UTC time)
    IF NEW.is_premium = TRUE THEN
        NEW.premium_date := NEW.created_date + INTERVAL '3 days';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_set_initial_premium_date
BEFORE INSERT ON users
FOR EACH ROW
EXECUTE FUNCTION set_initial_premium_date();

//categories table
CREATE TABLE categories (
  id BIGSERIAL PRIMARY KEY,
  title VARCHAR(15) NOT NULL,
  created_date TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_ex BOOLEAN NOT NULL,
  user_id BIGINT NOT NULL REFERENCES users(id)
);


//dengies table
CREATE TABLE dengies (
    id BIGSERIAL PRIMARY KEY,
    amount BIGINT NOT NULL,
    comment_text VARCHAR(30) DEFAULT NULL,
    created_date TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
    category_id BIGINT REFERENCES categories(id),
    user_id BIGINT REFERENCES users(id)
);

